<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Amex Split Tracker</title>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
:root{
  --bg:#0b0f19;--card:rgba(255,255,255,.06);--card2:rgba(255,255,255,.04);
  --text:rgba(255,255,255,.92);--muted:rgba(255,255,255,.6);
  --border:rgba(255,255,255,.12);
  --blue:#2f7dff;--pink:#ff4fb0;
}
*{box-sizing:border-box}
body{
  margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto;
  background:var(--bg);color:var(--text);
}
.wrap{max-width:1100px;margin:24px auto;padding:0 16px}
.card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:16px;margin-bottom:14px}
.grid{display:grid;grid-template-columns:1fr;gap:14px}
@media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}

button{padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:#222;color:white;cursor:pointer}
label{font-size:12px;color:var(--muted)}
input{color:white}

.kpis{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.kpi{background:var(--card2);border:1px solid var(--border);border-radius:16px;padding:14px}
.big{font-size:28px;font-weight:800}
.sub{font-size:12px;color:var(--muted)}
.pieWrap{height:260px;position:relative}
#pieInfo{position:absolute;right:10px;top:10px;font-size:13px}
</style>
</head>

<body>
<div class="wrap">

<h2>Amex Split Tracker</h2>

<div class="card">
  <label>Amex activity CSV</label>
  <input type="file" id="activity" accept=".csv"><br><br>
  <label>Aleeya payments CSV</label>
  <input type="file" id="payments" accept=".csv"><br><br>
  <button id="analyze">Analyze</button>
  <span id="status" style="margin-left:10px;color:var(--muted)"></span>
</div>

<!-- Month Navigation -->
<div class="card" style="display:flex;justify-content:space-between;align-items:center">
  <button id="prevMonth">◀</button>
  <div id="monthLabel" style="font-weight:700"></div>
  <button id="nextMonth">▶</button>
</div>

<div class="grid">
  <div class="card">
    <div class="pieWrap">
      <canvas id="pie"></canvas>
      <div id="pieInfo"></div>
    </div>
  </div>

  <div class="card">
    <div class="kpis">
      <div class="kpi">
        <div class="sub">Yousef spent</div>
        <div class="big" id="ys">£0</div>
        <div class="sub">Transactions</div>
        <div id="ytx">0</div>
      </div>
      <div class="kpi">
        <div class="sub">Aleeya spent</div>
        <div class="big" id="as">£0</div>
        <div class="sub">Transactions</div>
        <div id="atx">0</div>
      </div>
    </div>
  </div>
</div>

</div>

<script>
const $=id=>document.getElementById(id);
const GBP=n=>new Intl.NumberFormat("en-GB",{style:"currency",currency:"GBP"}).format(n);

let pieChart;
let MONTH_KEYS=[], MONTH_DATA={}, currentMonthIndex=0;

const parseCSV=f=>new Promise(res=>Papa.parse(f,{header:true,skipEmptyLines:true,complete:r=>res(r.data)}));
const parseDate=s=>{
  const p=String(s||"").split(/[\/-]/);
  return p.length===3 ? new Date(p[2],p[1]-1,p[0]) : null;
};
const monthKey=d=>d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0");

function renderMonth(idx){
  const key=MONTH_KEYS[idx];
  const m=MONTH_DATA[key];
  $("monthLabel").textContent=key;

  $("ys").textContent=GBP(m.ys);
  $("as").textContent=GBP(m.as);
  $("ytx").textContent=m.ytx;
  $("atx").textContent=m.atx;

  pieChart.data.datasets[0].data=[m.ys,m.as];
  pieChart.data.datasets[0].offset=[0,0];
  pieChart.update();
  $("pieInfo").innerHTML="";
}

$("analyze").onclick=async()=>{
  $("status").textContent="Loading...";
  const act=await parseCSV($("activity").files[0]);
  const pay=await parseCSV($("payments").files[0]);

  let monthly={};

  for(const r of act){
    const d=parseDate(r.Date);
    const amt=Number(r.Amount);
    if(!d||amt<=0) continue;
    const m=monthKey(d);
    monthly[m]??={ys:0,as:0,ytx:0,atx:0};
    if(/ALEEYA/i.test(r["Card Member"]||"")){
      monthly[m].as+=amt; monthly[m].atx++;
    }else{
      monthly[m].ys+=amt; monthly[m].ytx++;
    }
  }

  MONTH_KEYS=Object.keys(monthly).sort();
  MONTH_DATA=monthly;
  currentMonthIndex=MONTH_KEYS.length-1;

  pieChart=new Chart($("pie"),{
    type:"doughnut",
    data:{labels:["Yousef","Aleeya"],datasets:[{data:[0,0],backgroundColor:["#2f7dff","#ff4fb0"],cutout:"70%"}]},
    options:{
      onClick:(_,els)=>{
        if(!els.length) return;
        const i=els[0].index;
        pieChart.data.datasets[0].offset=[0,0];
        pieChart.data.datasets[0].offset[i]=18;
        pieChart.update();

        const m=MONTH_DATA[MONTH_KEYS[currentMonthIndex]];
        $("pieInfo").innerHTML=i===0
          ? `<b>Yousef</b><br>${GBP(m.ys)}<br>${m.ytx} tx`
          : `<b>Aleeya</b><br>${GBP(m.as)}<br>${m.atx} tx`;
      },
      plugins:{legend:{display:false}}
    }
  });

  renderMonth(currentMonthIndex);
  $("status").textContent="Done";
};

$("prevMonth").onclick=()=>{if(currentMonthIndex>0) renderMonth(--currentMonthIndex)};
$("nextMonth").onclick=()=>{if(currentMonthIndex<MONTH_KEYS.length-1) renderMonth(++currentMonthIndex)};
</script>

</body>
</html>
