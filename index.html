<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Amex Split Tracker</title>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
:root{
  --bg:#0b0f19;
  --card:rgba(255,255,255,.06);
  --border:rgba(255,255,255,.12);
  --text:rgba(255,255,255,.92);
  --muted:rgba(255,255,255,.6);

  /* Yousef – Olive Green */
  --blue:#617741;
  --blueDark:#2b361a;

  /* Aleeya – Baby Pastel Pink */
  --pink:#f2a7c4;
  --pinkDark:#e3518b;
}

*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto;background:var(--bg);color:var(--text)}
.wrap{max-width:480px;margin:0 auto;padding:16px}
.card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:16px;margin-bottom:14px}
h2,h3{margin:0 0 10px 0;font-weight:800}
.row{display:flex;justify-content:space-between;align-items:center;font-size:14px;margin-top:6px}
.dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px}
.kpiGrid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.kpi{text-align:center}
.mid{font-size:18px;font-weight:900}
.mid.remaining{font-size:22px;}
.sub{font-size:12px;color:var(--muted)}
canvas{max-width:100%}

/* Pie */
.pieWrap{position:relative}
.pieCenter{
  position:absolute;
  top:50%;left:50%;
  transform:translate(-50%,-50%);
  text-align:center;
  pointer-events:none;
}

#pcTotal{
  font-size:26px;   /* bigger total */
  font-weight:1000;
  margin-top:4px;
}

#pcTx{
  font-size:13px;   /* slightly bigger transactions */
}


/* Monthly */
.slider{overflow:hidden;border-radius:14px}
.slideTrack{display:flex;width:200%;transition:transform .25s ease}
.slide{width:50%}

/* Table */
.tableHeader{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.segment{
  display:flex;
  width:100%;
  border:1px solid var(--border);
  border-radius:14px;
  overflow:hidden;
  margin-bottom:10px;
}
.segBtn{
  flex:1;
  background:none;
  border:0;
  padding:10px 0;
  font-size:13px;
  color:rgba(255,255,255,.55);
  cursor:pointer;
}

.segBtn:not(:last-child){border-right:1px solid var(--border);}
.segBtn.active{background:rgba(255,255,255,.08); color:var(--text);}
table{width:100%;border-collapse:collapse;font-size:12px}
th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,.08)}
th{color:var(--muted);text-align:left}
.badge{padding:2px 8px;border-radius:999px;font-size:11px;border:1px solid rgba(255,255,255,.12)}

/* Paid Off Strike Through */ 
tr.paidOff {
  text-decoration: line-through;
  text-decoration-color: #ff4b4b;
  color: rgba(255,255,255,.55);
}

/* Repaid Strike Through */ 
tr.repaid {
  text-decoration: line-through;
  text-decoration-color: #35d07f;
  color: rgba(255,255,255,.55);
}

/* Dynamic Bar Actions */ 
.barAction{
  margin-top:10px;
  padding:10px 12px;
  border-radius:12px;
  background:rgba(255,255,255,.08);
  font-size:13px;
  line-height:1.4;
}

.barAction strong{
  font-size:18px;
  display:block;
}

.barAction .hint{
  color:var(--muted);
  font-size:12px;
}

.barAction .cta{
  margin-top:6px;
  color:var(--pink);
  font-weight:700;
}



</style>
</head>

<body>
<div class="wrap">

<!-- PIE -->
<div class="card">
  <h2>All-time spending</h2>
  <div class="pieWrap">
    <canvas id="pie" height="220"></canvas>
    <div class="pieCenter">
      <div id="pcTitle">Total</div>
      <div id="pcTotal">£0</div>
      <div class="sub" id="pcTx">0 transactions</div>
    </div>
  </div>
  <div class="row"><div><span class="dot" style="background:var(--blue)"></span>Yousef</div><div id="ys">£0</div></div>
  <div class="row"><div><span class="dot" style="background:var(--pink)"></span>Aleeya</div><div id="as">£0</div></div>
</div>

<!-- KPIs -->
<div class="kpiGrid">
  <div class="card kpi">
    <h3>Yousef</h3>
    <div class="sub">Remaining</div>
    <div class="mid remaining" id="yr">£0</div>
    <div class="sub">Paid</div>
    <div class="mid" id="yp">£0</div>
  </div>
  <div class="card kpi">
    <h3>Aleeya</h3>
    <div class="sub">Remaining</div>
    <div class="mid remaining" id="ar">£0</div>
    <div class="sub">Paid</div>
    <div class="mid" id="ap">£0</div>
  </div>
</div>

<!-- MONTHLY -->
<div class="card" id="monthCard">
  <h2 id="monthLabel">—</h2>

  <div class="slider">
    <div class="slideTrack">
      <div class="slide">
        <canvas id="bar" height="160"></canvas>
      </div>
      <div class="slide"></div>
    </div>
  </div>

  <!-- Action callout lives here -->
  <div class="barAction" id="barAction" hidden></div>
</div>


<!-- TABLE -->
<div class="card">
  <div class="tableHeader">
    <h2>Transactions</h2>
  </div>

  <div class="segment segment-full">
    <button class="segBtn active" id="fltDue">Due</button>
    <button class="segBtn" id="fltAll">All</button>
    <button class="segBtn" id="fltSpent">Spent</button>
    <button class="segBtn" id="fltPaid">Paid</button>
  </div>

  <table>
    <thead>
      <tr><th>Date</th><th>Type</th><th>Description</th><th>Amount</th></tr>
    </thead>
    <tbody id="aLedger"></tbody>
  </table>
</div>

</div>

<script>
const $ = id => document.getElementById(id);

const cssVar = name =>
  getComputedStyle(document.documentElement).getPropertyValue(name).trim();

const GBP = n => new Intl.NumberFormat("en-GB",{style:"currency",currency:"GBP"}).format(Math.max(0,n||0));
const parseDate = s => {
  const p=String(s||"").split(/[\/-]/);
  if(p.length!==3) return null;
  const d=new Date(p[2],p[1]-1,p[0]);
  return isNaN(d)?null:d;
};
const monthKey = d => d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0");
const monthPretty = k => new Date(k.split("-")[0],k.split("-")[1]-1)
  .toLocaleDateString("en-GB",{month:"long",year:"numeric"});

const fade = (color, alpha=0.35) =>
  color.startsWith("rgb")
    ? color.replace("rgb", "rgba").replace(")", `,${alpha})`)
    : color + Math.round(alpha*255).toString(16).padStart(2,"0");


/* ---------- Refund pairing (stable) ---------- */
function tokens(desc){
  const noise=new Set(["REFUND","REVERSAL","PAYMENT","CO","UK","LTD","LIMITED","WWW","COM"]);
  return String(desc||"").toUpperCase()
    .replace(/[^A-Z0-9 ]/g," ")
    .split(" ").filter(t=>t.length>=3&&!noise.has(t));
}
function similarity(A,B){
  let i=0; for(const t of A) if(B.has(t)) i++;
  return i/Math.min(A.size,B.size);
}
function stripRefundPairs(rows){
  const buckets=new Map(),meta=[];
  rows.forEach((r,i)=>{
    const amt=+r.Amount; if(!amt) return;
    const k=Math.round(Math.abs(amt)*100);
    meta[i]={amt,t:new Set(tokens(r.Description))};
    buckets.set(k,buckets.get(k)||{p:[],n:[]});
    (amt>0?buckets.get(k).p:buckets.get(k).n).push(i);
  });
  const used=new Set();
  for(const {p,n} of buckets.values()){
    for(const ni of n){
      let best=null,s=0;
      for(const pi of p){
        const sc=similarity(meta[pi].t,meta[ni].t);
        if(sc>s){s=sc;best=pi;}
      }
      if(best!==null&&s>=0.55){used.add(best);used.add(ni);}
    }
  }
  return rows.filter((_,i)=>!used.has(i));
}

(async()=>{
  const activityRaw = Papa.parse(await (await fetch("data/activity.csv")).text(),{header:true}).data;
  const payments = Papa.parse(await (await fetch("data/payments.csv")).text(),{header:true}).data;
  const activity = stripRefundPairs(activityRaw);

  let ySpend=0,aSpend=0,yTx=0,aTx=0,yPaidGross=0,aPaid=0;
  const monthly={},ensure=m=>monthly[m]??={ys:0,as:0,ypg:0,ap:0};
  let events=[];

  payments.forEach(r=>{
    const d=parseDate(r.Date); if(!d) return;
    const amt=Math.abs(+r.Amount||0); if(!amt) return;
    aPaid+=amt; ensure(monthKey(d)).ap+=amt;
    /* events.push({d,type:"paid",desc:"Repayment",amt:-amt}); */ 
    events.push({
      d,
      type:"paid",
      desc:"Repayment",
      amt:-amt,
      repaid:true
    });
  });

  const aleeyaPaymentAmounts = new Set(
    payments
      .map(r => Math.round(Math.abs(+r.Amount || 0) * 100))
      .filter(Boolean)
  );


  activity.forEach(r=>{
    const d=parseDate(r.Date); if(!d) return;
    const amt=+r.Amount||0; if(!amt) return;
    const m=monthKey(d),b=ensure(m);
    const isA=/ALEEYA/i.test(r["Card Member"]||"");
    if(amt>0){
      if(isA){aSpend+=amt;aTx++;b.as+=amt;
        /* events.push({d,type:"spent",desc:r.Description,amt})} */ 
        events.push({
          d,
          type:"spent",
          desc:r.Description,
          amt,
          paidOff: aleeyaPaymentAmounts.has(Math.round(amt * 100))
        })}
      else{ySpend+=amt;yTx++;b.ys+=amt}
    }else if(!isA&&/PAYMENT/i.test(r.Description)){
      yPaidGross+=Math.abs(amt); b.ypg+=Math.abs(amt);
    }
  });

  $("ys").textContent=GBP(ySpend);
  $("as").textContent=GBP(aSpend);
  $("yp").textContent=GBP(Math.max(0,yPaidGross-aPaid));
  $("yr").textContent=GBP(ySpend-(yPaidGross-aPaid));
  $("ap").textContent=GBP(aPaid);
  $("ar").textContent=GBP(aSpend-aPaid);

  /* ---------- PIE (interactive, animated, spaced) ---------- */
  const pie = new Chart($("pie"),{
    type:"doughnut",
    data:{
      labels:["Yousef","Aleeya"],
      datasets:[{
        data:[ySpend,aSpend],
        backgroundColor:[cssVar("--blue"), cssVar("--pink")],
        borderWidth:0,          // no white border
        cutout:"68%",
        spacing:6,             // gap between slices
        borderRadius:12,       // rounded slice edges
        offset:[0,0]
      }]
    },
    options:{
      plugins:{
        legend:{display:false},
        tooltip:{enabled:false}
      },
      animation:{
        duration:320,
        easing:"easeOutCubic"   // subtle smooth expansion
      },
      onClick:(_,els)=>{
        const ds = pie.data.datasets[0];

        // Reset (tap outside slices)
        if(!els.length){
          ds.offset = [0,0];
          $("pcTitle").textContent = "Total";
          $("pcTotal").textContent = GBP(ySpend + aSpend);
          $("pcTx").textContent = `${yTx + aTx} transactions`;
          pie.update();
          return;
        }

        // Expand selected slice
        const i = els[0].index;
        ds.offset = [0,0];
        ds.offset[i] = 22;   // expansion amount (keeps centre aligned)

        if(i === 0){
          $("pcTitle").textContent = "Yousef";
          $("pcTotal").textContent = GBP(ySpend);
          $("pcTx").textContent = `${yTx} transactions`;
        } else {
          $("pcTitle").textContent = "Aleeya";
          $("pcTotal").textContent = GBP(aSpend);
          $("pcTx").textContent = `${aTx} transactions`;
        }

        pie.update();
      }
    }
  });

  // Default centre state
  $("pcTotal").textContent = GBP(ySpend + aSpend);
  $("pcTx").textContent = `${yTx + aTx} transactions`;

  /* ---------- BAR ---------- */
  const months=Object.keys(monthly).sort();
  let idx=months.length-1;
  let selectedBarIndex = null;
  const bar=new Chart($("bar"),{
    type:"bar",
    data:{labels:["Spent","Paid","Spent","Paid"],datasets:[{
      data:[],
      backgroundColor:[
        cssVar("--blue"),
        cssVar("--blueDark"),
        cssVar("--pink"),
        cssVar("--pinkDark")
      ],
      borderRadius:8
    }]},
    options:{
      plugins:{
        legend:{display:false},
        tooltip:{enabled:false}
      }, 

      onClick:(evt, els)=>{
        const action = $("barAction");

        // Click outside → reset
        if(!els.length){
          selectedBarIndex = null;
          bar.data.datasets[0].backgroundColor = [...barBaseColors];
          action.hidden = true;
          bar.update();
          return;
        }

        selectedBarIndex = els[0].index;
        updateBarAction(selectedBarIndex);
      }

      }
  });

  const barBaseColors = [
    cssVar("--blue"),
    cssVar("--blueDark"),
    cssVar("--pink"),
    cssVar("--pinkDark")
  ];

  function updateBarAction(i){
    const action = $("barAction");
    const m = monthly[months[idx]];

    // Reset base colours first
    bar.data.datasets[0].backgroundColor = [...barBaseColors];

    // Fade non-selected bars
    bar.data.datasets[0].backgroundColor =
      bar.data.datasets[0].backgroundColor.map((c,ci)=>
        ci===i ? c : fade(c)
      );

    let label = "";
    let cta = "";

    if(i === 0) label = "Yousef spent";
    if(i === 1) label = "Yousef paid";

    if(i === 2){
      label = "Spent this month";
      const remaining = Math.max(0, m.as - m.ap);
      cta = remaining > 0
        ? `Repay ${GBP(remaining)} to settle this month`
        : "This month is settled";
    }

    if(i === 3){
      label = "Paid this month";
      const remaining = Math.max(0, m.as - m.ap);
      cta = remaining > 0
        ? `${GBP(remaining)} still outstanding this month`
        : "This month is settled";
    }

    const amount = GBP(bar.data.datasets[0].data[i]);

    action.innerHTML = `
      <div class="hint">${label}</div>
      <strong>${amount}</strong>
      ${cta ? `<div class="cta">${cta}</div>` : ""}
    `;
    action.hidden = false;

    bar.update();
  }

  function renderMonth(){
    const m=monthly[months[idx]];
    bar.data.datasets[0].data=[m.ys,Math.max(0,m.ypg-m.ap),m.as,m.ap];
    bar.update();
    $("monthLabel").textContent=monthPretty(months[idx]);
  }
  renderMonth();

  /* Swipe: RIGHT = previous, LEFT = next */
  let startX=0;
  $("monthCard").ontouchstart=e=>startX=e.touches[0].clientX;
  $("monthCard").ontouchend=e=>{
  const dx=e.changedTouches[0].clientX-startX;
    if(dx>40 && idx>0) idx--;
    if(dx<-40 && idx<months.length-1) idx++;
    renderMonth();

    if(selectedBarIndex !== null){
      updateBarAction(selectedBarIndex);
    }
  };
 

  /* ---------- TABLE ---------- */
  let filter="due";
  function setActive(btn){
    ["fltAll","fltSpent","fltPaid", "fltDue"].forEach(id=>$(id).classList.remove("active"));
    btn.classList.add("active");
  }
  function renderTable(){
    $("aLedger").innerHTML = events
      .filter(e=>{
        if(filter === "all") return true;
        if(filter === "spent") return e.type === "spent";
        if(filter === "paid") return e.type === "paid";
        if(filter === "due") return e.type === "spent" && !e.paidOff;
      })
      .sort((a,b)=>b.d-a.d)   // newest first
      /* .map(e=>`<tr> */ 
      .map(e=>`<tr class="${
          e.type==="spent" && e.paidOff ? "paidOff" :
          e.type==="paid" && e.repaid && filter!=="paid" ? "repaid" :
          ""
        }">
        <td>${e.d.toLocaleDateString("en-GB")}</td>
        <td><span class="badge">${e.type}</span></td>
        <td>${e.desc}</td>
        <td>${GBP(Math.abs(e.amt))}</td>
      </tr>`).join("");
  }
  $("fltAll").onclick=()=>{filter="all";setActive(fltAll);renderTable()};
  $("fltSpent").onclick=()=>{filter="spent";setActive(fltSpent);renderTable()};
  $("fltPaid").onclick=()=>{filter="paid";setActive(fltPaid);renderTable()};
  $("fltDue").onclick=()=>{filter="due"; setActive(fltDue); renderTable();};

  renderTable();

})();
</script>

</body>
</html>
