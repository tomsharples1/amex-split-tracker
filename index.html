<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Amex Split Tracker</title>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
:root{
  --bg:#0b0f19;
  --card:rgba(255,255,255,.06);
  --border:rgba(255,255,255,.12);
  --text:rgba(255,255,255,.92);
  --muted:rgba(255,255,255,.6);
  --blue:#2f7dff;
  --blueDark:#1f56b8;
  --pink:#ff4fb0;
  --pinkDark:#c93686;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
  background:var(--bg);
  color:var(--text);
}
.wrap{max-width:480px;margin:0 auto;padding:16px}
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:18px;
  padding:16px;
  margin-bottom:14px;
}
.row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-top:8px;
  font-size:14px;
}
.dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px}
.kpiGrid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.kpi{text-align:center}
.big{font-size:26px;font-weight:800}
.mid{font-size:18px;font-weight:700}
.sub{font-size:12px;color:var(--muted)}
table{width:100%;border-collapse:collapse;font-size:12px}
th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,.08)}
th{text-align:left;color:var(--muted)}
</style>
</head>

<body>
<div class="wrap">

<!-- PIE -->
<div class="card">
  <h2>Spending</h2>
  <canvas id="pie" height="220"></canvas>
  <div class="row">
    <div><span class="dot" style="background:var(--blue)"></span>Yousef</div>
    <div id="ys">£0</div>
  </div>
  <div class="row">
    <div><span class="dot" style="background:var(--pink)"></span>Aleeya</div>
    <div id="as">£0</div>
  </div>
</div>

<!-- KPIs -->
<div class="kpiGrid">
  <div class="card kpi">
    <h3>Yousef</h3>
    <div class="sub">Paid</div>
    <div class="mid" id="yp">£0</div>
    <div class="sub">Remaining</div>
    <div class="mid" id="yr">£0</div>
  </div>
  <div class="card kpi">
    <h3>Aleeya</h3>
    <div class="sub">Paid</div>
    <div class="mid" id="ap">£0</div>
    <div class="sub">Remaining</div>
    <div class="mid" id="ar">£0</div>
  </div>
</div>

<!-- BAR -->
<div class="card">
  <h2>Monthly Recap</h2>
  <canvas id="bar" height="180"></canvas>
</div>

<!-- TABLE -->
<div class="card">
  <h2>Aleeya Transactions</h2>
  <table>
    <thead>
      <tr>
        <th>Date</th>
        <th>Type</th>
        <th>Description</th>
        <th>Amount</th>
      </tr>
    </thead>
    <tbody id="aLedger"></tbody>
  </table>
</div>

</div>

<script>
const GBP = n =>
  new Intl.NumberFormat("en-GB",{style:"currency",currency:"GBP"}).format(n);

const parseDate = s => {
  const p = String(s).split(/[\/-]/);
  return new Date(p[2], p[1]-1, p[0]);
};

async function loadCSV(path){
  const res = await fetch(path);
  const text = await res.text();
  return Papa.parse(text,{header:true,skipEmptyLines:true}).data;
}

/* ---------- REFUND LOGIC ---------- */
function tokenize(desc){
  const noise = new Set(["REFUND","REVERSAL","PAYMENT","CO","UK","LTD","LIMITED","WWW","COM"]);
  return String(desc||"")
    .toUpperCase()
    .replace(/[^A-Z0-9 ]/g," ")
    .split(" ")
    .filter(t=>t.length>=3 && !noise.has(t));
}

function similarity(a,b){
  const A=new Set(a), B=new Set(b);
  let i=0; A.forEach(t=>B.has(t)&&i++);
  return i/Math.min(A.size,B.size||1);
}

function stripRefunds(rows){
  const used=new Set(), buckets={};
  rows.forEach((r,i)=>{
    const amt=Math.round(Math.abs(Number(r.Amount))*100);
    if(!amt) return;
    buckets[amt]??={pos:[],neg:[]};
    (Number(r.Amount)>0?buckets[amt].pos:buckets[amt].neg).push(i);
  });

  Object.values(buckets).forEach(({pos,neg})=>{
    neg.forEach(n=>{
      if(used.has(n)) return;
      const nt=tokenize(rows[n].Description);
      pos.forEach(p=>{
        if(used.has(p)) return;
        if(similarity(nt,tokenize(rows[p].Description))>=0.55){
          used.add(n); used.add(p);
        }
      });
    });
  });

  return rows.filter((_,i)=>!used.has(i));
}

/* ---------- MAIN ---------- */
(async function(){
  let activity = await loadCSV("data/activity.csv");
  const payments = await loadCSV("data/payments.csv");

  activity = stripRefunds(activity);

  let ySpend=0,aSpend=0,yPaid=0,aPaid=0;
  let monthly={}, aRows=[];

  payments.forEach(r=>{
    const amt=Math.abs(Number(r.Amount));
    const d=parseDate(r.Date);
    aPaid+=amt;
    const m=d.getFullYear()+"-"+(d.getMonth()+1);
    monthly[m]??={ys:0,yp:0,as:0,ap:0};
    monthly[m].ap+=amt;
    aRows.push({d,type:"Paid",desc:"Repayment",amt:-amt});
  });

  activity.forEach(r=>{
    const amt=Number(r.Amount);
    const d=parseDate(r.Date);
    const m=d.getFullYear()+"-"+(d.getMonth()+1);
    monthly[m]??={ys:0,yp:0,as:0,ap:0};

    const isAleeya=/ALEEYA/i.test(r["Card Member"]||"");

    if(amt>0){
      if(isAleeya){
        aSpend+=amt; monthly[m].as+=amt;
        aRows.push({d,type:"Spent",desc:r.Description,amt});
      } else {
        ySpend+=amt; monthly[m].ys+=amt;
      }
    } else if(!isAleeya && /PAYMENT/i.test(r.Description||"")){
      yPaid+=Math.abs(amt); monthly[m].yp+=Math.abs(amt);
    }
  });

  yPaid=Math.max(0,yPaid-aPaid);

  ys.textContent=GBP(ySpend);
  as.textContent=GBP(aSpend);
  yp.textContent=GBP(yPaid);
  yr.textContent=GBP(ySpend-yPaid);
  ap.textContent=GBP(aPaid);
  ar.textContent=GBP(aSpend-aPaid);

  new Chart(pie,{
    type:"doughnut",
    data:{datasets:[{data:[ySpend,aSpend],backgroundColor:["#2f7dff","#ff4fb0"],spacing:6,borderRadius:10,cutout:"70%"}]},
    options:{plugins:{legend:{display:false}}}
  });

  const labels=Object.keys(monthly).sort();
  new Chart(bar,{
    type:"bar",
    data:{
      labels,
      datasets:[
        {data:labels.map(m=>monthly[m].ys),backgroundColor:"#2f7dff",borderRadius:6},
        {data:labels.map(m=>monthly[m].yp),backgroundColor:"#1f56b8",borderRadius:6},
        {data:labels.map(m=>monthly[m].as),backgroundColor:"#ff4fb0",borderRadius:6},
        {data:labels.map(m=>monthly[m].ap),backgroundColor:"#c93686",borderRadius:6}
      ]
    },
    options:{
      plugins:{legend:{display:false}},
      scales:{
        x:{title:{display:true,text:"Month"}},
        y:{title:{display:true,text:"£"}}
      }
    }
  });

  aRows.sort((a,b)=>a.d-b.d);
  aLedger.innerHTML=aRows.map(r=>`
    <tr>
      <td>${r.d.toLocaleDateString("en-GB")}</td>
      <td>${r.type}</td>
      <td>${r.desc}</td>
      <td>${GBP(r.amt)}</td>
    </tr>`).join("");
})();
</script>

</body>
</html>
