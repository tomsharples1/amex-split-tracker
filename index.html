<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Amex Split Tracker</title>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
:root{
  --bg:#0b0f19;
  --card:rgba(255,255,255,.06);
  --border:rgba(255,255,255,.12);
  --text:rgba(255,255,255,.92);
  --muted:rgba(255,255,255,.6);
  --blue:#2f7dff;
  --blueDark:#1f56b8;
  --pink:#ff4fb0;
  --pinkDark:#c93686;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
  background:var(--bg);
  color:var(--text);
}
.wrap{
  max-width:420px;
  margin:0 auto;
  padding:16px;
}
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:18px;
  padding:16px;
  margin-bottom:14px;
}
h1{
  font-size:18px;
  margin:0 0 12px 0;
}
.row{
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.name{
  display:flex;
  align-items:center;
  gap:8px;
  font-weight:600;
}
.dot{
  width:10px;
  height:10px;
  border-radius:50%;
}
.blue{background:var(--blue)}
.pink{background:var(--pink)}
.big{
  font-size:26px;
  font-weight:800;
}
.sub{
  font-size:12px;
  color:var(--muted);
}
.kpiRow{
  display:flex;
  justify-content:space-between;
  margin-top:8px;
}
canvas{
  max-width:100%;
}
table{
  width:100%;
  border-collapse:collapse;
  font-size:12px;
}
th,td{
  padding:8px 6px;
  border-bottom:1px solid rgba(255,255,255,.08);
}
th{
  text-align:left;
  color:var(--muted);
}
.badge{
  padding:2px 8px;
  border-radius:999px;
  font-size:11px;
  background:rgba(255,255,255,.08);
}
</style>
</head>

<body>
<div class="wrap">
  <h1>Amex Split Tracker</h1>

  <!-- PIE CARD -->
  <div class="card">
    <canvas id="pie" height="220"></canvas>

    <div style="margin-top:12px">
      <div class="row">
        <div class="name"><span class="dot blue"></span>Yousef</div>
        <div class="name"><span class="dot pink"></span>Aleeya</div>
      </div>

      <div class="row" style="margin-top:10px">
        <div class="sub">Total Amex spend</div>
        <div class="big" id="totalSpend">£0</div>
      </div>
    </div>
  </div>

  <!-- YOUSEF KPI -->
  <div class="card">
    <div class="name"><span class="dot blue"></span>Yousef</div>
    <div class="kpiRow">
      <div>
        <div class="sub">Paid</div>
        <div class="big" id="yPaid">£0</div>
      </div>
      <div>
        <div class="sub">Remaining</div>
        <div class="big" id="yRemain">£0</div>
      </div>
    </div>
  </div>

  <!-- ALEEYA KPI -->
  <div class="card">
    <div class="name"><span class="dot pink"></span>Aleeya</div>
    <div class="kpiRow">
      <div>
        <div class="sub">Paid</div>
        <div class="big" id="aPaid">£0</div>
      </div>
      <div>
        <div class="sub">Remaining</div>
        <div class="big" id="aRemain">£0</div>
      </div>
    </div>
  </div>

  <!-- TABLE -->
  <div class="card">
    <h3 style="margin:0 0 10px 0">Aleeya – spending & repayments</h3>
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Type</th>
          <th>Description</th>
          <th>Amount</th>
        </tr>
      </thead>
      <tbody id="ledger"></tbody>
    </table>
  </div>
</div>

<script>
const GBP = n => new Intl.NumberFormat("en-GB",{style:"currency",currency:"GBP"}).format(n);

async function loadCSV(path){
  const res = await fetch(path);
  const text = await res.text();
  return Papa.parse(text,{header:true,skipEmptyLines:true}).data;
}

function parseDate(s){
  const [d,m,y] = s.split(/[\/-]/);
  return new Date(y,m-1,d);
}

(async function init(){
  const activity = await loadCSV("data/activity.csv");
  const payments = await loadCSV("data/aleeya_payments.csv");

  let ySpend=0, aSpend=0, yPaid=0, aPaid=0;
  let ledger=[];

  for(const r of payments){
    const amt=Math.abs(+r.Amount);
    aPaid+=amt;
    ledger.push({date:r.Date,type:"Paid",desc:"Repayment",amt:-amt});
  }

  for(const r of activity){
    const amt=+r.Amount;
    if(!amt) continue;
    const isAleeya=/ALEEYA/i.test(r["Card Member"]||"");

    if(amt>0){
      if(isAleeya){
        aSpend+=amt;
        ledger.push({date:r.Date,type:"Spent",desc:r.Description,amt});
      }else{
        ySpend+=amt;
      }
    }else if(/PAYMENT/i.test(r.Description||"") && !isAleeya){
      yPaid+=Math.abs(amt);
    }
  }

  const totalSpend = ySpend + aSpend;

  document.getElementById("totalSpend").textContent = GBP(totalSpend);
  document.getElementById("yPaid").textContent = GBP(yPaid);
  document.getElementById("yRemain").textContent = GBP(Math.max(0,ySpend-yPaid));
  document.getElementById("aPaid").textContent = GBP(aPaid);
  document.getElementById("aRemain").textContent = GBP(Math.max(0,aSpend-aPaid));

  new Chart(document.getElementById("pie"),{
    type:"doughnut",
    data:{
      datasets:[{
        data:[ySpend,aSpend],
        backgroundColor:["#2f7dff","#ff4fb0"],
        borderWidth:0,
        spacing:4,
        borderRadius:10,
        cutout:"70%"
      }]
    },
    options:{plugins:{legend:{display:false}}}
  });

  ledger.sort((a,b)=>parseDate(a.date)-parseDate(b.date));
  document.getElementById("ledger").innerHTML =
    ledger.map(l=>`
      <tr>
        <td>${l.date}</td>
        <td><span class="badge">${l.type}</span></td>
        <td>${l.desc}</td>
        <td>${GBP(l.amt)}</td>
      </tr>`).join("");
})();
</script>
</body>
</html>
