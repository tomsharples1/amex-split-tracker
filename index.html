<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Amex Split Tracker</title>

<link rel="manifest" href="manifest.json">
<!-- iOS PWA support -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Split Tracker">

<link rel="apple-touch-icon" href="icons/icon-1024.png">

<!-- Papa for reading csv files -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
:root{
  --bg:#0b0f19;
  --card:rgba(255,255,255,.06);
  --border:rgba(255,255,255,.12);
  --text:rgba(255,255,255,.92);
  --muted:rgba(255,255,255,.6);

  /* Yousef – Olive Green */
  --blue:#617741;
  --blueDark:#8cb948;

  /* Aleeya – Baby Pastel Pink */
  --pink:#f2a7c4;
  --pinkDark:#e3518b;
}


*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
  color:var(--text);

  background:
    radial-gradient(
      900px at 20% -20%,
      rgba(242,167,196,.35) 0%,
      rgba(242,167,196,0) 60%
    ),
    radial-gradient(
      1000px at 80% 10%,
      rgba(97,119,65,.35) 0%,
      rgba(97,119,65,0) 65%
    ),
    #0b0f19;

    background-attachment: fixed;
}

.wrap{max-width:480px;margin:0 auto;padding:16px}


h2{
  margin:0 0 10px 0;
  font-weight:700;
  letter-spacing:-.01em;
}

h3{
  margin:0 0 10px 0;
  font-weight:800;
}
.row{display:flex;justify-content:space-between;align-items:center;font-size:14px;margin-top:6px}
.dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px}
.kpiGrid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.kpi{text-align:center}
.mid{font-size:18px;font-weight:900}
.mid.remaining{font-size:26px; letter-spacing:-.02em;}
.sub{font-size:12px;color:var(--muted)}
canvas{max-width:100%}

.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:18px;
  padding:16px;
  margin-bottom:14px;
  box-shadow:
    0 10px 30px rgba(0,0,0,.25),
    inset 0 1px 0 rgba(255,255,255,.04);
  transition:transform .2s ease, box-shadow .2s ease;
}

.card:active{
  transform:translateY(1px);
}

/* KPI Headings */ 
.kpi.yousef h3{color:var(--blue);}
.kpi.aleeya h3{color:var(--pink);}
.spendingCard .kpi{
  background:none;
  border:0;
  box-shadow:none;
  padding:0;
}

/* KPI Progress Bars */ 
.kpiVertical{
  display:flex;
  align-items:stretch;
  gap:12px;
}

.kpiContent{
  flex:1;
  text-align:center;
}

.kpiBar{
  width:6px;
  background:rgba(255,255,255,.08);
  border-radius:999px;
  position:relative;
  overflow:hidden;
}

.kpiBar span{
  position:absolute;
  bottom:0;
  left:0;
  width:100%;
  height:0%;
  border-radius:999px;
  transition:height .4s ease;
}

.kpiBar.left{
  margin-right:4px;
}

.kpiBar.right{
  margin-left:4px;
}



/* Pie */
.pieWrap{position:relative}
.pieCenter{
  position:absolute;
  top:50%;left:50%;
  transform:translate(-50%,-50%);
  text-align:center;
  pointer-events:none;
}

#pcTitle{
  font-size:12px;
  letter-spacing:.06em;
  color:var(--muted);
}


#pcTotal{
  font-size:28px;
  font-weight:800;
  letter-spacing:-.01em;
  margin-top:4px;
  -webkit-font-smoothing:antialiased;
  text-rendering:optimizeLegibility;
}


#pcTx{
  font-size:13px;   /* slightly bigger transactions */
}


/* Monthly */
.slider{overflow:hidden;border-radius:14px}
.slideTrack{display:flex;width:200%;transition:transform .25s ease}
.slide{width:50%}

/* Table */
.tableHeader{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:12px;
}
.segment{
  display:flex;
  width:100%;
  border:1px solid var(--border);
  border-radius:14px;
  overflow:hidden;
  margin-bottom:10px;
}

.segBtn{
  flex:1;
  background:none;
  border:0;
  padding:10px 0;
  font-size:13px;
  color:rgba(255,255,255,.55);
  cursor:pointer;
  transition:background .2s ease, color .2s ease, transform .1s ease;
}

.segBtn.segWide{
  flex:1.4; /* slightly wider than the others */
}

.segBtn.segWide.active{
  font-weight:600;
}

.segBtn:active{
  transform:scale(.97);
}


.segBtn:not(:last-child){border-right:1px solid var(--border);}
.segBtn.active{background:rgba(255,255,255,.08); color:var(--text);}
table{
  width:100%;
  border-collapse:collapse;
  font-size:12px;
  table-layout:fixed;
}
th, td{
  padding:8px;
  border-bottom:1px solid rgba(255,255,255,.08);
  vertical-align:top;
  word-break:break-word;
  overflow-wrap:anywhere;
}
th{color:var(--muted);text-align:left}


/* Column sizing */
th:nth-child(1),
td:nth-child(1){
  width:82px;          /* was 70px */
  white-space:nowrap; /* prevent date wrapping */
}


th:nth-child(2),
td:nth-child(2){ width:70px; }

th:nth-child(4),
td:nth-child(4){
  width:80px;
  text-align:right;
}

th:nth-child(3),
td:nth-child(3){
  width:auto;
}


.badge{padding:2px 8px;border-radius:999px;font-size:11px;border:1px solid rgba(255,255,255,.12)}

/* Paid Off Strike Through */ 
tr.paidOff {
  text-decoration: line-through;
  text-decoration-color: #ff4b4b;
  color: rgba(255,255,255,.55);
}

/* Repaid Strike Through */ 
tr.repaid {
  text-decoration: line-through;
  text-decoration-color: #35d07f;
  color: rgba(255,255,255,.55);
}

/* Dynamic Bar Actions */ 
.barAction{
  margin-top:10px;
  padding:10px 12px;
  border-radius:12px;
  background:rgba(255,255,255,.08);
  font-size:13px;
  line-height:1.4;
}

.barAction strong{
  font-size:18px;
  display:block;
}

.barAction .hint{
  color:var(--muted);
  font-size:12px;
}

.barAction .cta{
  margin-top:6px;
  color:var(--pink);
  font-weight:700;
}

.progress {
  margin-top:8px;
  height:6px;
  background:rgba(255,255,255,.08);
  border-radius:999px;
  overflow:hidden;
}

.progress > span {
  display:block;
  height:100%;
  border-radius:999px;
  transition:width .4s ease;
}

.divider{
  height:1px;
  background:rgba(255,255,255,.08);
  margin:16px 0;
}

tr.activeRow {
  background: rgba(255,255,255,.08);
}



</style>
</head>

<body>
<div class="wrap">

<!-- SPENDING + KPIs -->
<div class="card spendingCard">
  <h2>Spending</h2>

  <div class="pieWrap">
    <canvas id="pie" height="200"></canvas>
    <div class="pieCenter">
      <div id="pcTitle">Total</div>
      <div id="pcTotal">£0</div>
      <div class="sub" id="pcTx">0 transactions</div>
    </div>
  </div>

  <div class="divider"></div>

  <div class="kpiGrid">
    <div class="kpi yousef kpiVertical">
      <div class="kpiBar left">
        <span id="ypProg" style="background:var(--blue)"></span>
      </div>

      <div class="kpiContent">
        <h3>Yousef</h3>
        <div class="sub">Outstanding</div>
        <div class="mid remaining" id="yr">£0</div>
        <div class="sub">Repaid</div>
        <div class="mid" id="yp">£0</div>
      </div>
    </div>

    <div class="kpi aleeya kpiVertical">
      <div class="kpiContent">
        <h3>Aleeya</h3>
        <div class="sub">Outstanding</div>
        <div class="mid remaining" id="ar">£0</div>
        <div class="sub">Repaid</div>
        <div class="mid" id="ap">£0</div>
      </div>

      <div class="kpiBar right">
        <span id="apProg" style="background:var(--pink)"></span>
      </div>
    </div>
  </div>
</div>



<!-- MONTHLY -->
<div class="card" id="monthCard">
  <h2 id="monthLabel">—</h2>

  <div class="slider">
    <div class="slideTrack">
      <div class="slide">
        <canvas id="bar" height="160"></canvas>
      </div>
      <div class="slide"></div>
    </div>
  </div>

  <!-- Action callout lives here -->
  <div class="barAction" id="barAction" hidden></div>
</div>


<!-- TABLE -->
<div class="card">
  <div class="tableHeader">
    <h2>Transactions</h2>

    <div class="sub">
      Selected total:
      <strong id="selectedTotal">£0</strong>
    </div>
  </div>

  <div class="segment segment-full">
    <button class="segBtn segWide active" id="fltDue">Outstanding</button>
    <button class="segBtn" id="fltAll">All</button>
    <button class="segBtn" id="fltSpent">Spent</button>
    <button class="segBtn" id="fltPaid">Paid</button>
  </div>

  <table>
    <thead>
      <tr><th>Date</th><th>Type</th><th>Description</th><th>Amount</th></tr>
    </thead>
    <tbody id="aLedger"></tbody>
  </table>
</div>

</div>

<script>
const $ = id => document.getElementById(id);

const cssVar = name =>
  getComputedStyle(document.documentElement).getPropertyValue(name).trim();

const GBP = n => new Intl.NumberFormat("en-GB",{style:"currency",currency:"GBP"}).format(Math.max(0,n||0));

const displayType = type =>
  type === "paid" ? "Paid" :
  type === "spent" ? "Spend" :
  type === "refund" ? "Refund":
  type;

const parseDate = s => {
  if (!s) return null;

  // Handle DD/MM/YYYY
  const m = String(s).match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
  if (m) {
    const [_, d, mo, y] = m;
    return new Date(y, mo - 1, d);
  }

  const d = new Date(s);
  return isNaN(d) ? null : d;
};


/* ---------- CSV normalisation (headers only) ---------- */
function normaliseHeader(header){
  return String(header || "")
    .toLowerCase()
    .replace(/[^a-z ]+/g, "")   // remove everything except letters + spaces
    .trim()
    .replace(/\s+/g, "_");      // spaces → underscore
}

const monthKey = d => d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0");
const monthPretty = k => new Date(k.split("-")[0],k.split("-")[1]-1)
  .toLocaleDateString("en-GB",{month:"long",year:"numeric"});

const fade = (color, alpha=0.35) =>
  color.startsWith("rgb")
    ? color.replace("rgb", "rgba").replace(")", `,${alpha})`)
    : color + Math.round(alpha*255).toString(16).padStart(2,"0");


function animateNumber(el, from, to, duration=300){
  const start = performance.now();
  function tick(now){
    const p = Math.min((now - start) / duration, 1);
    const v = from + (to - from) * p;
    el.textContent = GBP(v);
    if(p < 1) requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);
}

function animateInt(el, from, to, suffix="", duration=250){
  const start = performance.now();
  function tick(now){
    const p = Math.min((now - start) / duration, 1);
    const v = Math.round(from + (to - from) * p);
    el.textContent = `${v}${suffix}`;
    if(p < 1) requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);
}


/* Default inital pie centre value for animation */ 
let pieCentreValue = 0;
let pieCentreTx = 0;

let focusOwner = null; // null | "aleeya" | "yousef"


/* ---------- Refund matching helpers (UI-only) ---------- */
const STOP_WORDS = new Set([
  "THE","AND","PAYMENT","REFUND","REVERSAL","CARD","LIMITED","LTD",
  "UK","WWW","COM","STORE","ONLINE","PURCHASE"
]);

const MERCHANT_STOP_WORDS = new Set([
  "THE","AND","OF","TO","FROM",
  "PAYMENT","PAID","RECEIVED","THANK","YOU",
  "CARD","PURCHASE","DEBIT","CREDIT",
  "ONLINE","ORDER","POS","STORE",
  "LIMITED","LTD","PLC","LLP",
  "UK","GB","GBR","LONDON",
  "WWW","COM","HTTP","HTTPS"
]);


function tokenize(desc){
  return new Set(
    String(desc || "")
      .toUpperCase()
      .replace(/[^A-Z0-9 ]/g, " ")
      .split(/\s+/)
      .filter(t => t.length >= 3 && !STOP_WORDS.has(t))
  );
}

function jaccard(a, b){
  let inter = 0;
  for (const t of a) if (b.has(t)) inter++;
  return inter / Math.max(1, a.size + b.size - inter);
}

function normaliseMerchant(desc){
  if (!desc) return "";

  const tokens = desc
    .toUpperCase()
    .replace(/[^A-Z0-9 ]/g, " ")
    .split(/\s+/)
    .filter(t =>
      t.length >= 3 &&
      !MERCHANT_STOP_WORDS.has(t) &&
      !/^\d+$/.test(t)
    );

  if (!tokens.length) return "";

  // Prefer the strongest brand-like token(s)
  // ASOS, AMAZON, UBER, STARBUCKS, etc
  return tokens.slice(0, 2).join(" ");
}

function summariseDescription(desc, type){
  if (type === "paid") return "Repayment";

  const merchant = normaliseMerchant(desc);

  if (type === "refund") {
    return merchant ? `${merchant} refund` : "Refund";
  }

  return merchant || "Card spend";
}



(async()=>{
  /*
  const API_BASE = "http://localhost:3001";
  const activityRaw = await fetch(`${API_BASE}/activity`).then(r => r.json());
  const payments = await fetch(`${API_BASE}/payments`).then(r => r.json());
  */ 

  /* Reading in CSV data */ 
  const activityRaw = Papa.parse(
    await (await fetch("data/activity.csv")).text(),
    {
      header: true,
      skipEmptyLines: true,
      transformHeader: normaliseHeader
    }
  ).data;

  const payments = Papa.parse(
    await (await fetch("data/payments.csv")).text(),
    {
      header: true,
      skipEmptyLines: true,
      transformHeader: normaliseHeader
    }
  ).data;

  // const activity = stripRefundPairs(activityRaw);
  const activity = activityRaw; 
  
  let ySpend=0,aSpend=0,yTx=0,aTx=0,yPaidGross=0,aPaid=0;
  const monthly={},ensure=m=>monthly[m]??={ys:0,as:0,ypg:0,ap:0};

  let events=[];
  let eventId = 0;

  // New Payments 
  let lastAleeyaPaymentDate = null;

  payments.forEach(r=>{
    const d = parseDate(r.date); if(!d) return;
    const amt = Math.abs(+r.amount || 0); if(!amt) return;

    aPaid += amt;
    ensure(monthKey(d)).ap += amt;

    if (!lastAleeyaPaymentDate || d > lastAleeyaPaymentDate) {
      lastAleeyaPaymentDate = d;
    }

    events.push({
      id: eventId++,
      d,
      type: "paid",
      desc: "Repayment",
      amt: -amt,
      repaid: true,
      owner: "aleeya"
    });
  });


  /*
  payments.forEach(r=>{
    const d=parseDate(r.date); if(!d) return;
    const amt=Math.abs(+r.amount||0); if(!amt) return;
    aPaid+=amt; ensure(monthKey(d)).ap+=amt;
    events.push({
      id: eventId++,
      d,
      type: "paid",
      desc: "Repayment",
      amt: -amt,
      repaid: true, 
      owner: "aleeya"
    });
  });*/

  /* ---------- Group refunds by vendor + day ---------- */
  function groupRefunds(events){
    const groups = new Map();

    events.forEach(e => {
      if (e.type !== "refund") return;

      const day = e.d.toISOString().slice(0,10);
      const tokens = tokenize(e.desc);
      const key = day + "::" + [...tokens].sort().join("|");

      if (!groups.has(key)) {
        groups.set(key, {
          date: e.d,
          tokens,
          amount: 0
        });
      }

      groups.get(key).amount += Math.abs(e.amt);
    });

    return [...groups.values()];
  }

  // Replace the Set with a count-map (in pennies)
  const aleeyaPaymentCounts = new Map();
  payments.forEach(r => {
    const cents = Math.round(Math.abs(+r.amount || 0) * 100);
    if (!cents) return;
    aleeyaPaymentCounts.set(cents, (aleeyaPaymentCounts.get(cents) || 0) + 1);
  });

  function consumeAleeyaPaymentFor(amt) {
    const cents = Math.round(Math.abs(amt) * 100);
    const n = aleeyaPaymentCounts.get(cents) || 0;
    if (n <= 0) return false;
    if (n === 1) aleeyaPaymentCounts.delete(cents);
    else aleeyaPaymentCounts.set(cents, n - 1);
    return true;
  }


  // Transaction Helpers 
  const isPayment = r =>
    r.amount < 0 && /PAYMENT/i.test(r.description || "");

  const isRefund = r =>
    r.amount < 0 && !/PAYMENT/i.test(r.description || "");

  const isSpend = r =>
    r.amount > 0;



  activity.forEach(r => {
    const d = parseDate(r.date);
    if (!d) return;

    const amt = +r.amount || 0;
    if (!amt) return;

    const m = monthKey(d);
    const b = ensure(m);

    const isA = /ALEEYA/i.test(r.card_member || "");

    /* ---------- SPEND ---------- */
    if (isSpend(r)) {
      if (isA) {
        aSpend += amt;
        aTx++;
        b.as += amt;

        events.push({
          id: eventId++,
          d,
          type: "spent",
          desc: r.description,
          amt,
          paidOff: consumeAleeyaPaymentFor(amt)
        });
      } else {
        ySpend += amt;
        yTx++;
        b.ys += amt;
      }
    }

    /* ---------- REFUND ---------- */
    if (isRefund(r)) {
      const refund = Math.abs(amt);

      if (isA) {
        aSpend -= refund;
        b.as -= refund;
      } else {
        ySpend -= refund;
        b.ys -= refund;
      }

      events.push({
        id: eventId++,
        d,
        type: "refund",
        desc: r.description,
        amt: -refund,
      });
    }

    /* ---------- PAYMENT ---------- */
    if (isPayment(r)) {
      const payment = Math.abs(amt);

      // All payments reduce total liability (primary cardholder)
      yPaidGross += payment;
      b.ypg += payment;

      events.push({
        id: eventId++,
        d,
        type: "paid",
        desc: r.description,
        amt: -payment,
        repaid: true,
        owner: "yousef"
      });
    }
  });


  /*
  $("yp").textContent = GBP(Math.max(0, yPaidGross - aPaid));
  $("yr").textContent = GBP(ySpend - (yPaidGross - aPaid));
  $("ap").textContent = GBP(aPaid);
  $("ar").textContent = GBP(aSpend - aPaid);
  */

  // Numeric outstanding / repaid values (SOURCE OF TRUTH)
  const yousefOutstanding = Math.max(0, ySpend - (yPaidGross - aPaid));
  const aleeyaOutstanding = Math.max(0, aSpend - aPaid);
  const totalOutstanding = yousefOutstanding + aleeyaOutstanding;

  // Render KPIs
  $("yp").textContent = GBP(Math.max(0, yPaidGross - aPaid));
  $("yr").textContent = GBP(yousefOutstanding);
  $("ap").textContent = GBP(aPaid);
  $("ar").textContent = GBP(aleeyaOutstanding);


  /* Progress Bar */
  const aleeyaPct = aSpend ? (aPaid / aSpend) * 100 : 0;
  const yousefPct = ySpend ? ((yPaidGross - aPaid) / ySpend) * 100 : 0;

  $("apProg").style.height = `${Math.min(100, aleeyaPct)}%`;
  $("ypProg").style.height = `${Math.min(100, yousefPct)}%`;


  function renderCentreKPI(){
    // GLOBAL VIEW
    if (!focusOwner) {
      $("pcTitle").textContent = "Outstanding balance";

      animateNumber(
        $("pcTotal"),
        pieCentreValue,
        totalOutstanding
      );
      pieCentreValue = totalOutstanding;

      animateInt(
        $("pcTx"),
        pieCentreTx,
        yTx + aTx,
        " transactions"
      );
      pieCentreTx = yTx + aTx;

      return;
    }

    // ALEEEYA FOCUS
    if (focusOwner === "aleeya") {
      $("pcTitle").textContent = "Aleeya owes";

      animateNumber(
        $("pcTotal"),
        pieCentreValue,
        aleeyaOutstanding
      );
      pieCentreValue = aleeyaOutstanding;

      $("pcTx").textContent =
        lastAleeyaPaymentDate
          ? `Last payment ${lastAleeyaPaymentDate.toLocaleDateString(
              "en-GB",
              { day: "numeric", month: "short" }
            )}`
          : "No payments yet";
    }

    // YOUSEF FOCUS
    if (focusOwner === "yousef") {
      $("pcTitle").textContent = "Yousef owes";

      animateNumber(
        $("pcTotal"),
        pieCentreValue,
        yousefOutstanding
      );
      pieCentreValue = yousefOutstanding;

      $("pcTx").textContent = "";
    }
  }




  /* ---------- PIE (interactive, animated, spaced) ---------- */
  const pie = new Chart($("pie"),{
    type:"doughnut",
    data:{
      labels:["Yousef","Aleeya"],
      datasets:[{
        data:[ySpend,aSpend],
        backgroundColor:[cssVar("--blue"), cssVar("--pink")],
        borderWidth:0,
        cutout:"68%",
        spacing:6,
        borderRadius:12,
        offset:[0,0],
        radius:["100%","100%"]
      }]
    },
    options:{
      plugins:{
        legend:{display:false},
        tooltip:{enabled:false}
      },
      animation:{
        duration:260,
        easing:"easeOutBack"   // subtle smooth expansion
      },
      onClick:(_,els)=>{
        const ds = pie.data.datasets[0];

        // Reset (tap outside slices)
        /*
        if(!els.length){
          ds.offset = [0,0];
          ds.radius = ["100%","100%"];
          $("pcTitle").textContent = "Total";
          animateNumber($("pcTotal"), pieCentreValue, ySpend + aSpend);
          pieCentreValue = ySpend + aSpend;
          animateInt($("pcTx"), pieCentreTx, yTx + aTx, " transactions");
          pieCentreTx = yTx + aTx;
          pie.update();
          return;
        }*/
       // Reset (tap outside slices)
        if (!els.length) {
          focusOwner = null;
          renderCentreKPI();
          pie.data.datasets[0].offset = [0,0];
          pie.update();
          return;
        }


        // Expand selected slice
        /*
        const i = els[0].index;
        ds.offset = [0,0];
        ds.offset[i] = 10;   // expansion amount (keeps centre aligned)

        if(i === 0){
          $("pcTitle").textContent = "Yousef";
          animateNumber($("pcTotal"), pieCentreValue, ySpend);
          pieCentreValue = ySpend;
          
          animateInt($("pcTx"), pieCentreTx, yTx, " transactions");
          pieCentreTx = yTx;

        } else {
          $("pcTitle").textContent = "Aleeya";
          animateNumber($("pcTotal"), pieCentreValue, aSpend);
          pieCentreValue = aSpend; 
          
          animateInt($("pcTx"), pieCentreTx, aTx, " transactions");
          pieCentreTx = aTx;
        }

        pie.update();
        */

        // Render PIE
        const i = els[0].index;
        const owner = i === 0 ? "yousef" : "aleeya";

        focusOwner = owner;

        pie.data.datasets[0].offset = [0,0];
        pie.data.datasets[0].offset[i] = 10;

        renderCentreKPI();
        pie.update();

      }
    }
  });

  // Default centre state
  renderCentreKPI();

  /* ---------- Refund allocation (UI-only) ---------- */
  function applyAtomicRefundMatching(events){
  const spends = events
    .filter(e => e.type === "spent")
    .map(e => ({
      ...e,
      tokens: tokenize(e.desc),
      remaining: e.amt,
      refunded: false
    }));

  const refunds = groupRefunds(events);

  refunds.forEach(ref => {
    // candidate spends: same vendor, before refund date, not refunded
    const candidates = spends
      .filter(s =>
        !s.refunded &&
        s.d <= ref.date
      )
      .map(s => ({
        spend: s,
        score: jaccard(ref.tokens, s.tokens)
      }))
      .filter(x => x.score >= 0.25)
      .sort((a, b) =>
        b.score - a.score ||     // best vendor match
        b.spend.d - a.spend.d   // most recent first
      );

    for (const { spend } of candidates) {
      
      if (ref.amount <= spend.remaining) {
        spend.remaining -= ref.amount;
        spend.refundApplied = ref.amount;
        spend.refunded = true;
        break; // refund handled, move on
      }
      // else: skip this spend and look further back
    }
  });

  return spends;
}


  /* Build lookup for table rendering */
  const refundedSpends = applyAtomicRefundMatching(events);
  const refundMap = new Map(refundedSpends.map(s => [s.id, s]));


  /* ---------- BAR ---------- */
  const months=Object.keys(monthly).sort();
  let idx=months.length-1;
  let selectedBarIndex = null;
  const bar=new Chart($("bar"),{
    type:"bar",
    data:{labels:["Spent","Repaid","Spent","Repaid"],datasets:[{
      data:[],
      backgroundColor:[
        cssVar("--blue"),
        cssVar("--blueDark"),
        cssVar("--pink"),
        cssVar("--pinkDark")
      ],
      borderRadius:8
    }]},
    options:{
      plugins:{
        legend:{display:false},
        tooltip:{enabled:false}
      }, 

      onClick:(evt, els)=>{
        const action = $("barAction");

        // Click outside → reset
        if(!els.length){
          selectedBarIndex = null;
          bar.data.datasets[0].backgroundColor = [...barBaseColors];
          action.hidden = true;
          bar.update();
          return;
        }

        selectedBarIndex = els[0].index;
        updateBarAction(selectedBarIndex);
      }

      }
  });

  const barBaseColors = [
    cssVar("--blue"),
    cssVar("--blueDark"),
    cssVar("--pink"),
    cssVar("--pinkDark")
  ];

  function updateBarAction(i){
    const action = $("barAction");
    const m = monthly[months[idx]];

    bar.data.datasets[0].backgroundColor = [...barBaseColors]
      .map((c,ci)=> ci===i ? c : fade(c));

    let title = "";
    let message = "";

    // Yousef
    if(i === 0){
      const remaining = Math.max(0, m.ys - (m.ypg - m.ap));
      title = `Yousef spent ${GBP(m.ys)} this month`;
      message = remaining > 0
        ? `Next: Repay ${GBP(remaining)} to settle this month`
        : `This month is fully settled`;
    }

    if(i === 1){
      const remaining = Math.max(0, m.ys - (m.ypg - m.ap));
      title = `Yousef repaid ${GBP(m.ypg - m.ap)} this month`;
      message = remaining > 0
        ? `${GBP(remaining)} still outstanding`
        : `This month is fully settled`;
    }

    // Aleeya
    if(i === 2){
      const remaining = Math.max(0, m.as - m.ap);
      title = `Aleeya spent ${GBP(m.as)} this month`;
      message = remaining > 0
        ? `Next: Repay ${GBP(remaining)} to settle this month`
        : `This month is fully settled`;
    }

    if(i === 3){
      const remaining = Math.max(0, m.as - m.ap);
      title = `Aleeya repaid ${GBP(m.ap)} this month`;
      message = remaining > 0
        ? `${GBP(remaining)} still outstanding`
        : `This month is fully settled`;
    }

    action.innerHTML = `
      <strong>${title}</strong>
      <div class="hint">${message}</div>
    `;
    action.hidden = false;

    bar.update();
  }


  function renderMonth(){
    const m=monthly[months[idx]];
    bar.data.datasets[0].data=[m.ys,Math.max(0,m.ypg-m.ap),m.as,m.ap];
    bar.update();
    $("monthLabel").textContent=monthPretty(months[idx]);
  }
  renderMonth();

  /* Swipe: RIGHT = previous, LEFT = next */
  let startX=0;
  $("monthCard").ontouchstart=e=>startX=e.touches[0].clientX;
  $("monthCard").ontouchend=e=>{
  const dx=e.changedTouches[0].clientX-startX;
    if(dx>40 && idx>0) idx--;
    if(dx<-40 && idx<months.length-1) idx++;
    renderMonth();

    if(selectedBarIndex !== null){
      updateBarAction(selectedBarIndex);
    }
  };
 

  // Selected Rows for Table 
  const selectedRows = new Set();

  function updateSelectedKPI() {
    const total = events
      .filter(e => selectedRows.has(e.id))
      .reduce((sum, e) => sum + Math.abs(e.amt), 0);

    $("selectedTotal").textContent = GBP(total);
  }

  function resetSelection() {
    selectedRows.clear();
    updateSelectedKPI();
  }

  /* ---------- TABLE ---------- */
  let filter="due";
  function setActive(btn){
    ["fltAll","fltSpent","fltPaid", "fltDue"].forEach(id=>$(id).classList.remove("active"));
    btn.classList.add("active");
  }

  function renderTable(){
    $("aLedger").innerHTML = events
      .filter(e=>{
        if(filter === "all") {
          // hide refunds that aren't aleeya's 
          if (e.type === "refund" && e.owner === "aleeya") return false;
        return true;
        }
        if(filter === "spent") return e.type === "spent";
        if(filter === "paid") return e.type === "paid" && e.owner === "aleeya" ;
        if (filter === "due") {
          // Weird Due logic now we added complex refund attribution 
          if (e.type !== "spent") return false;

          // refunded to zero OR paid off → not outstanding
          if (refundMap.has(e.id) && refundMap.get(e.id).remaining === 0) return false;
          if (e.paidOff) return false;

          return true;
        }
      })
      .sort((a,b)=>b.d-a.d)
      .map(e => `
        <tr
          data-id="${e.id}"
          class="
            ${selectedRows.has(e.id) ? "activeRow" : ""}
            ${
              e.type==="spent" && e.paidOff ? "paidOff" :
              e.type==="paid" && e.repaid && filter!=="paid" ? "repaid" :
              ""
            }
          "
        >
          <td>${e.d.toLocaleDateString("en-GB")}</td>
          <td><span class="badge">${displayType(e.type)}</span></td>
          <td>${summariseDescription(e.desc, e.type)}</td>
          <td>
            ${
              e.type === "spent" && refundMap.has(e.id)
                ? GBP(refundMap.get(e.id).remaining)
                : GBP(Math.abs(e.amt))
            }
            ${
              refundMap.get(e.id)?.refundApplied
                ? `<div class="sub">−${GBP(refundMap.get(e.id).refundApplied)} refunded</div>`
                : ""
            }
          </td>
        </tr>
      `)
      .join("");

    document.querySelectorAll("#aLedger tr").forEach(row => {
      row.onclick = () => {
        const id = Number(row.dataset.id);

        if (selectedRows.has(id)) {
          selectedRows.delete(id);
        } else {
          selectedRows.add(id);
        }

        updateSelectedKPI();
        renderTable();
      };
    });
  }

  $("fltAll").onclick=()=>{filter="all";setActive(fltAll);resetSelection();renderTable()};
  $("fltSpent").onclick=()=>{filter="spent";setActive(fltSpent);resetSelection();renderTable()};
  $("fltPaid").onclick=()=>{filter="paid";setActive(fltPaid);resetSelection();renderTable()};
  $("fltDue").onclick=()=>{filter="due"; setActive(fltDue);resetSelection();renderTable();};

  renderTable();
  updateSelectedKPI();

})();
</script>

</body>
</html>
