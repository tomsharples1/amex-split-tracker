<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Amex Split Tracker</title>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
:root{
  --bg:#0b0f19;
  --card:rgba(255,255,255,.06);
  --border:rgba(255,255,255,.12);
  --text:rgba(255,255,255,.92);
  --muted:rgba(255,255,255,.6);
  --blue:#2f7dff;
  --blueDark:#1f56b8;
  --pink:#ff4fb0;
  --pinkDark:#c93686;
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:-apple-system,system-ui,Segoe UI,Roboto;
  background:var(--bg);
  color:var(--text);
}

.wrap{
  max-width:420px;
  margin:0 auto;
  padding:16px;
}

.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:18px;
  padding:16px;
  margin-bottom:14px;
}

/* PIE CARD */
.pieWrap{height:220px}
.nameRow{
  display:flex;
  justify-content:space-between;
  margin-top:10px;
  font-size:14px;
}
.nameRow div{
  display:flex;
  align-items:center;
  gap:6px;
}
.dot{
  width:10px;
  height:10px;
  border-radius:50%;
}
.blue{background:var(--blue)}
.pink{background:var(--pink)}
.total{
  font-weight:700;
}

/* KPI CARDS */
.kpiGrid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
}
.kpi h3{
  margin:0 0 6px 0;
  font-size:14px;
}
.kpi .label{
  font-size:12px;
  color:var(--muted);
}
.kpi .value{
  font-size:20px;
  font-weight:800;
  margin-bottom:8px;
}

/* BAR CHART */
.barWrap{
  height:200px;
}

/* TABLE */
table{
  width:100%;
  border-collapse:collapse;
  font-size:12px;
}
th,td{
  padding:8px 6px;
  border-bottom:1px solid rgba(255,255,255,.08);
}
th{
  color:var(--muted);
  text-align:left;
}
.badge{
  font-size:11px;
  padding:2px 8px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.15);
}
</style>
</head>

<body>
<div class="wrap">

  <!-- PIE CARD -->
  <div class="card">
    <div class="pieWrap">
      <canvas id="pie"></canvas>
    </div>

    <div class="nameRow">
      <div><span class="dot blue"></span>Yousef <span class="total" id="ys">£0</span></div>
      <div><span class="dot pink"></span>Aleeya <span class="total" id="as">£0</span></div>
    </div>
  </div>

  <!-- KPI CARDS -->
  <div class="kpiGrid">
    <div class="card kpi">
      <h3>Yousef</h3>
      <div class="label">Paid</div>
      <div class="value" id="yp">£0</div>
      <div class="label">Remaining</div>
      <div class="value" id="yr">£0</div>
    </div>

    <div class="card kpi">
      <h3>Aleeya</h3>
      <div class="label">Paid</div>
      <div class="value" id="ap">£0</div>
      <div class="label">Remaining</div>
      <div class="value" id="ar">£0</div>
    </div>
  </div>

  <!-- BAR CHART -->
  <div class="card barWrap">
    <canvas id="bar"></canvas>
  </div>

  <!-- TABLE -->
  <div class="card">
    <h3 style="margin:0 0 10px 0">Aleeya – spending & repayments</h3>
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Type</th>
          <th>Description</th>
          <th>Amount</th>
        </tr>
      </thead>
      <tbody id="ledger"></tbody>
    </table>
  </div>

</div>

<script>
const GBP=n=>new Intl.NumberFormat("en-GB",{style:"currency",currency:"GBP"}).format(n);

async function loadCSV(path){
  const r = await fetch(path);
  const t = await r.text();
  return Papa.parse(t,{header:true,skipEmptyLines:true}).data;
}

const parseDate=d=>{
  const p=d.split(/[\/-]/);
  return new Date(p[2],p[1]-1,p[0]);
};

(async()=>{
  const activity = await loadCSV("data/activity.csv");
  const payments = await loadCSV("data/payments.csv");

  let ySpend=0, aSpend=0, yPaid=0, aPaid=0;
  let ledger=[];
  let monthly={};

  /* ALEEYA PAYMENTS */
  payments.forEach(r=>{
    const amt=Math.abs(+r.Amount);
    const d=parseDate(r.Date);
    aPaid+=amt;
    const m=d.getFullYear()+"-"+(d.getMonth()+1);
    monthly[m]??={ys:0,as:0,yp:0,ap:0};
    monthly[m].ap+=amt;
    ledger.push({d,type:"Paid",desc:"Repayment",amt:-amt});
  });

  /* ACTIVITY */
  activity.forEach(r=>{
    const amt=+r.Amount;
    const d=parseDate(r.Date);
    const m=d.getFullYear()+"-"+(d.getMonth()+1);
    monthly[m]??={ys:0,as:0,yp:0,ap:0};
    const isAleeya=/ALEEYA/i.test(r["Card Member"]||"");

    if(amt>0){
      if(isAleeya){
        aSpend+=amt;
        monthly[m].as+=amt;
        ledger.push({d,type:"Spent",desc:r.Description,amt});
      }else{
        ySpend+=amt;
        monthly[m].ys+=amt;
      }
    }else if(!isAleeya && /PAYMENT/i.test(r.Description)){
      yPaid+=Math.abs(amt);
      monthly[m].yp+=Math.abs(amt);
    }
  });

  /* REMOVE ALEEYA PAYMENTS FROM YOUSEF */
  yPaid=Math.max(0,yPaid-aPaid);

  /* KPIs */
  document.getElementById("ys").textContent=GBP(ySpend);
  document.getElementById("as").textContent=GBP(aSpend);
  document.getElementById("yp").textContent=GBP(yPaid);
  document.getElementById("yr").textContent=GBP(ySpend-yPaid);
  document.getElementById("ap").textContent=GBP(aPaid);
  document.getElementById("ar").textContent=GBP(aSpend-aPaid);

  /* PIE */
  new Chart(document.getElementById("pie"),{
    type:"doughnut",
    data:{
      datasets:[{
        data:[ySpend,aSpend],
        backgroundColor:["#2f7dff","#ff4fb0"],
        borderWidth:0,
        spacing:4,
        borderRadius:10
      }]
    },
    options:{cutout:"70%",plugins:{legend:{display:false}}}
  });

  /* BAR */
  const labels=Object.keys(monthly).sort();
  new Chart(document.getElementById("bar"),{
    type:"bar",
    data:{
      labels,
      datasets:[
        {data:labels.map(m=>monthly[m].ys),backgroundColor:"#2f7dff",borderRadius:6},
        {data:labels.map(m=>monthly[m].yp),backgroundColor:"#1f56b8",borderRadius:6},
        {data:labels.map(m=>monthly[m].as),backgroundColor:"#ff4fb0",borderRadius:6},
        {data:labels.map(m=>monthly[m].ap),backgroundColor:"#c93686",borderRadius:6}
      ]
    },
    options:{
      plugins:{legend:{display:false}},
      scales:{x:{display:false},y:{display:false}}
    }
  });

  /* TABLE */
  ledger.sort((a,b)=>a.d-b.d);
  document.getElementById("ledger").innerHTML=
    ledger.map(r=>`
      <tr>
        <td>${r.d.toLocaleDateString("en-GB")}</td>
        <td><span class="badge">${r.type}</span></td>
        <td>${r.desc}</td>
        <td>${GBP(r.amt)}</td>
      </tr>`).join("");
})();
</script>
</body>
</html>
