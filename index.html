<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Amex Split Tracker</title>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
:root{
  --bg:#0b0f19;
  --card:rgba(255,255,255,.06);
  --border:rgba(255,255,255,.12);
  --text:rgba(255,255,255,.92);
  --muted:rgba(255,255,255,.6);
  --blue:#2f7dff;
  --pink:#ff4fb0;
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
  background:var(--bg);
  color:var(--text);
}

.wrap{
  max-width:480px;
  margin:0 auto;
  padding:16px;
}

.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:18px;
  padding:16px;
  margin-bottom:14px;
}

h2,h3{margin:0 0 10px 0}

.row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:14px;
  margin-top:6px;
}

.dot{
  width:10px;
  height:10px;
  border-radius:50%;
  display:inline-block;
  margin-right:6px;
}

.kpiGrid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
}

.kpi{text-align:center}
.mid{font-size:18px;font-weight:800}
.sub{font-size:12px;color:var(--muted)}

canvas{max-width:100%}

/* Pie centre */
.pieWrap{position:relative}
.pieCenter{
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  text-align:center;
  pointer-events:none;
}
.pieCenter .title{font-size:13px;font-weight:800}
.pieCenter .val{font-size:18px;font-weight:900;margin-top:4px}
.pieCenter .sub{font-size:12px;color:var(--muted)}

/* Monthly swipe hint */
.hint{
  font-size:12px;
  color:var(--muted);
  text-align:center;
  margin-top:8px;
}

/* Error */
.err{
  display:none;
  border:1px solid rgba(255,79,176,.4);
  background:rgba(255,79,176,.1);
}
</style>
</head>

<body>
<div class="wrap">

<div class="card err" id="err">
  <h3>Error</h3>
  <pre id="errText"></pre>
</div>

<!-- PIE -->
<div class="card">
  <h2>All-time spending</h2>
  <div class="pieWrap">
    <canvas id="pie" height="220"></canvas>
    <div class="pieCenter" id="pieCenter">
      <div class="title">Total</div>
      <div class="val" id="pcTotal">£0</div>
      <div class="sub" id="pcTx">0 transactions</div>
    </div>
  </div>

  <div class="row">
    <div><span class="dot" style="background:var(--blue)"></span>Yousef</div>
    <div id="ys">£0</div>
  </div>
  <div class="row">
    <div><span class="dot" style="background:var(--pink)"></span>Aleeya</div>
    <div id="as">£0</div>
  </div>
</div>

<!-- KPIs -->
<div class="kpiGrid">
  <div class="card kpi">
    <h3>Yousef</h3>
    <div class="sub">Paid</div>
    <div class="mid" id="yp">£0</div>
    <div class="sub">Remaining</div>
    <div class="mid" id="yr">£0</div>
  </div>
  <div class="card kpi">
    <h3>Aleeya</h3>
    <div class="sub">Paid</div>
    <div class="mid" id="ap">£0</div>
    <div class="sub">Remaining</div>
    <div class="mid" id="ar">£0</div>
  </div>
</div>

<!-- MONTHLY -->
<div class="card" id="monthCard">
  <h2 id="monthLabel">Monthly recap</h2>
  <canvas id="bar" height="160"></canvas>
  <div class="hint">Swipe left / right to change month</div>
</div>

</div>

<script>
const $=id=>document.getElementById(id);
const GBP=n=>new Intl.NumberFormat("en-GB",{style:"currency",currency:"GBP"}).format(Math.max(0,n||0));

function showErr(e){
  $("err").style.display="block";
  $("errText").textContent=e.stack||e;
}

/* Utils */
const parseDate=s=>{
  const p=String(s||"").split(/[\/-]/);
  if(p.length!==3) return null;
  const d=new Date(p[2],p[1]-1,p[0]);
  return isNaN(d)?null:d;
};
const monthKey=d=>d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0");
const monthPretty=k=>{
  const [y,m]=k.split("-");
  return new Date(y,m-1).toLocaleDateString("en-GB",{month:"long",year:"numeric"});
};

async function loadCSV(p){
  const r=await fetch(p,{cache:"no-store"});
  if(!r.ok) throw new Error("Failed to load "+p);
  return Papa.parse(await r.text(),{header:true,skipEmptyLines:true}).data;
}

/* State */
let pieChart, barChart;
let months=[], monthly={}, mIdx=0;

/* Init */
(async()=>{
try{
  let activity=await loadCSV("data/activity.csv");
  const payments=await loadCSV("data/payments.csv");

  let ySpend=0,aSpend=0,yTx=0,aTx=0,yPaidGross=0,aPaid=0;

  const ensure=m=>monthly[m]??={ys:0,as:0,ypg:0,ap:0};

  payments.forEach(r=>{
    const d=parseDate(r.Date); if(!d) return;
    const amt=Math.abs(+r.Amount); if(!amt) return;
    aPaid+=amt;
    ensure(monthKey(d)).ap+=amt;
  });

  activity.forEach(r=>{
    const d=parseDate(r.Date); if(!d) return;
    const amt=+r.Amount; if(!amt) return;
    const m=monthKey(d); ensure(m);
    const isA=/ALEEYA/i.test(r["Card Member"]||"");
    if(amt>0){
      if(isA){aSpend+=amt;aTx++;monthly[m].as+=amt;}
      else{ySpend+=amt;yTx++;monthly[m].ys+=amt;}
    }else if(!isA && /PAYMENT/i.test(r.Description)){
      yPaidGross+=Math.abs(amt);
      monthly[m].ypg+=Math.abs(amt);
    }
  });

  months=Object.keys(monthly).sort();
  mIdx=months.length-1;

  /* KPIs */
  const yPaid=Math.max(0,yPaidGross-aPaid);
  $("ys").textContent=GBP(ySpend);
  $("as").textContent=GBP(aSpend);
  $("yp").textContent=GBP(yPaid);
  $("yr").textContent=GBP(ySpend-yPaid);
  $("ap").textContent=GBP(aPaid);
  $("ar").textContent=GBP(aSpend-aPaid);

  /* PIE */
  pieChart=new Chart(pie,{
    type:"doughnut",
    data:{
      labels:["Yousef","Aleeya"],
      datasets:[{
        data:[ySpend,aSpend],
        backgroundColor:["#2f7dff","#ff4fb0"],
        borderWidth:0,
        cutout:"68%",
        offset:[0,0]
      }]
    },
    options:{
      plugins:{legend:{display:false}},
      onClick:(_,els)=>{
        if(!els.length){
          pieChart.data.datasets[0].offset=[0,0];
          pieChart.data.datasets[0].backgroundColor=["#2f7dff","#ff4fb0"];
          pieChart.update();
          $("pcTotal").textContent=GBP(ySpend+aSpend);
          $("pcTx").textContent=(yTx+aTx)+" transactions";
          $("pieCenter").querySelector(".title").textContent="Total";
          return;
        }
        const i=els[0].index;
        pieChart.data.datasets[0].offset=[0,0];
        pieChart.data.datasets[0].offset[i]=28;
        pieChart.data.datasets[0].backgroundColor=[
          i===0?"#2f7dff":"rgba(47,125,255,.25)",
          i===1?"#ff4fb0":"rgba(255,79,176,.25)"
        ];
        pieChart.update();
        $("pieCenter").querySelector(".title").textContent=i===0?"Yousef":"Aleeya";
        $("pcTotal").textContent=GBP(i===0?ySpend:aSpend);
        $("pcTx").textContent=(i===0?yTx:aTx)+" transactions";
      }
    }
  });

  $("pcTotal").textContent=GBP(ySpend+aSpend);
  $("pcTx").textContent=(yTx+aTx)+" transactions";

  /* BAR */
  barChart=new Chart(bar,{
    type:"bar",
    data:{labels:["Yousef spend","Yousef paid","Aleeya spend","Aleeya paid"],datasets:[{data:[0,0,0,0],backgroundColor:["#2f7dff","#1f56b8","#ff4fb0","#c93686"],borderRadius:6}]},
    options:{plugins:{legend:{display:false}}}
  });

  function renderMonth(){
    const k=months[mIdx];
    const m=monthly[k];
    $("monthLabel").textContent=monthPretty(k);
    const yPaidNet=Math.max(0,m.ypg-m.ap);
    barChart.data.datasets[0].data=[m.ys,yPaidNet,m.as,m.ap];
    barChart.update();
  }

  renderMonth();

  /* Swipe */
  let sx=null;
  $("monthCard").addEventListener("touchstart",e=>sx=e.touches[0].clientX,{passive:true});
  $("monthCard").addEventListener("touchend",e=>{
    if(sx===null) return;
    const dx=e.changedTouches[0].clientX-sx;
    if(Math.abs(dx)>50){
      if(dx<0 && mIdx<months.length-1) mIdx++;
      if(dx>0 && mIdx>0) mIdx--;
      renderMonth();
    }
    sx=null;
  },{passive:true});

}catch(e){showErr(e)}
})();
</script>

</body>
</html>
