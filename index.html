<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Amex Split Tracker</title>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
:root{
  --bg:#0b0f19;
  --card:rgba(255,255,255,.06);
  --border:rgba(255,255,255,.12);
  --text:rgba(255,255,255,.92);
  --muted:rgba(255,255,255,.6);
  --blue:#2f7dff;
  --blueDark:#1f56b8;
  --pink:#ff4fb0;
  --pinkDark:#c93686;
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
  background:var(--bg);
  color:var(--text);
}
.wrap{
  max-width:480px;
  margin:0 auto;
  padding:16px;
}
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:18px;
  padding:16px;
  margin-bottom:14px;
}
h2,h3{margin:0 0 10px 0;font-weight:800}
.row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:14px;
  margin-top:6px;
}
.dot{
  width:10px;height:10px;border-radius:50%;
  display:inline-block;margin-right:6px;
}
.kpiGrid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
}
.kpi{text-align:center}
.mid{font-size:18px;font-weight:900}
.sub{font-size:12px;color:var(--muted)}
canvas{max-width:100%}

/* Pie centre */
.pieWrap{position:relative}
.pieCenter{
  position:absolute;
  top:50%;left:50%;
  transform:translate(-50%,-50%);
  text-align:center;
  pointer-events:none;
}
.pieCenter .title{font-size:13px;font-weight:900}
.pieCenter .val{font-size:18px;font-weight:1000;margin-top:4px}
.pieCenter .sub{font-size:12px;color:var(--muted)}

/* Monthly swipe animation */
.slider{
  position:relative;
  overflow:hidden;
  border-radius:14px;
}
.slideTrack{
  display:flex;
  width:200%;
  transition:transform 260ms ease;
}
.slide{
  width:50%;
}

/* Table */
.tableHeader{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
  margin-bottom:8px;
}
.segment{
  display:inline-flex;
  border:1px solid var(--border);
  border-radius:12px;
  overflow:hidden;
}
.segBtn{
  background:none;
  border:0;
  color:var(--muted);
  padding:6px 10px;
  font-size:12px;
  cursor:pointer;
}
.segBtn.active{
  background:rgba(255,255,255,.08);
  color:var(--text);
}
table{
  width:100%;
  border-collapse:collapse;
  font-size:12px;
}
th,td{
  padding:8px;
  border-bottom:1px solid rgba(255,255,255,.08);
}
th{color:var(--muted);text-align:left}
.badge{
  padding:2px 8px;
  border-radius:999px;
  font-size:11px;
  border:1px solid rgba(255,255,255,.12);
}
</style>
</head>

<body>
<div class="wrap">

<!-- PIE -->
<div class="card">
  <h2>All-time spending</h2>

  <div class="pieWrap">
    <canvas id="pie" height="220"></canvas>
    <div class="pieCenter">
      <div class="title" id="pcTitle">Total</div>
      <div class="val" id="pcTotal">£0</div>
      <div class="sub" id="pcTx">0 transactions</div>
    </div>
  </div>

  <div class="row">
    <div><span class="dot" style="background:var(--blue)"></span>Yousef</div>
    <div id="ys">£0</div>
  </div>
  <div class="row">
    <div><span class="dot" style="background:var(--pink)"></span>Aleeya</div>
    <div id="as">£0</div>
  </div>
</div>

<!-- KPIs -->
<div class="kpiGrid">
  <div class="card kpi">
    <h3>Yousef</h3>
    <div class="sub">Paid</div>
    <div class="mid" id="yp">£0</div>
    <div class="sub">Remaining</div>
    <div class="mid" id="yr">£0</div>
  </div>
  <div class="card kpi">
    <h3>Aleeya</h3>
    <div class="sub">Paid</div>
    <div class="mid" id="ap">£0</div>
    <div class="sub">Remaining</div>
    <div class="mid" id="ar">£0</div>
  </div>
</div>

<!-- MONTHLY -->
<div class="card" id="monthCard">
  <h2 id="monthLabel">—</h2>

  <div class="slider">
    <div class="slideTrack" id="track">
      <div class="slide"><canvas id="barA" height="160"></canvas></div>
      <div class="slide"><canvas id="barB" height="160"></canvas></div>
    </div>
  </div>
</div>

<!-- TABLE -->
<div class="card">
  <div class="tableHeader">
    <h2>Aleeya Transactions</h2>
    <div class="segment">
      <button class="segBtn active" id="fltAll">All</button>
      <button class="segBtn" id="fltSpent">Spent</button>
      <button class="segBtn" id="fltPaid">Paid</button>
    </div>
  </div>

  <table>
    <thead>
      <tr>
        <th>Date</th>
        <th>Type</th>
        <th>Description</th>
        <th>Amount</th>
      </tr>
    </thead>
    <tbody id="aLedger"></tbody>
  </table>
</div>

</div>

<script>
const $=id=>document.getElementById(id);
const GBP=n=>new Intl.NumberFormat("en-GB",{style:"currency",currency:"GBP"}).format(Math.max(0,n||0));

const parseDate=s=>{
  const p=String(s||"").split(/[\/-]/);
  if(p.length!==3) return null;
  const d=new Date(p[2],p[1]-1,p[0]);
  return isNaN(d)?null:d;
};
const monthKey=d=>d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0");
const monthPretty=k=>{
  const [y,m]=k.split("-");
  return new Date(y,m-1).toLocaleDateString("en-GB",{month:"long",year:"numeric"});
};

/* Refund pairing */
function tokens(desc){
  const noise=new Set(["REFUND","REVERSAL","PAYMENT","CO","UK","LTD","LIMITED","WWW","COM"]);
  return String(desc||"").toUpperCase().replace(/[^A-Z0-9 ]/g," ")
    .split(" ").filter(t=>t.length>=3&&!noise.has(t));
}
function similarity(A,B){
  let i=0; for(const t of A) if(B.has(t)) i++;
  return i/Math.min(A.size,B.size);
}
function stripRefundPairs(rows){
  const buckets=new Map(),meta=[];
  rows.forEach((r,i)=>{
    const amt=+r.Amount; if(!amt) return;
    const k=Math.round(Math.abs(amt)*100);
    const t=new Set(tokens(r.Description));
    meta[i]={amt,t};
    buckets.set(k,buckets.get(k)||{p:[],n:[]});
    (amt>0?buckets.get(k).p:buckets.get(k).n).push(i);
  });
  const used=new Set();
  for(const {p,n} of buckets.values()){
    for(const ni of n){
      let best=null,s=0;
      for(const pi of p){
        const sc=similarity(meta[pi].t,meta[ni].t);
        if(sc>s){s=sc;best=pi;}
      }
      if(best!==null&&s>=0.55){used.add(best);used.add(ni);}
    }
  }
  return rows.filter((_,i)=>!used.has(i));
}

/* Load */
(async()=>{
  const activity=stripRefundPairs(await (await fetch("data/activity.csv")).text().then(t=>Papa.parse(t,{header:true}).data));
  const payments=await (await fetch("data/payments.csv")).text().then(t=>Papa.parse(t,{header:true}).data);

  let ySpend=0,aSpend=0,yTx=0,aTx=0,yPaidGross=0,aPaid=0;
  const monthly={},ensure=m=>monthly[m]??={ys:0,as:0,ypg:0,ap:0};
  const events=[];

  payments.forEach(r=>{
    const d=parseDate(r.Date); if(!d) return;
    const amt=Math.abs(+r.Amount); if(!amt) return;
    aPaid+=amt; ensure(monthKey(d)).ap+=amt;
    events.push({d,type:"paid",desc:"Repayment",amt:-amt});
  });

  activity.forEach(r=>{
    const d=parseDate(r.Date); if(!d) return;
    const amt=+r.Amount; if(!amt) return;
    const m=monthKey(d),b=ensure(m);
    const isA=/ALEEYA/i.test(r["Card Member"]||"");
    if(amt>0){
      if(isA){aSpend+=amt;aTx++;b.as+=amt;events.push({d,type:"spent",desc:r.Description,amt});}
      else{ySpend+=amt;yTx++;b.ys+=amt;}
    }else if(!isA&&/PAYMENT/i.test(r.Description)){
      yPaidGross+=Math.abs(amt); b.ypg+=Math.abs(amt);
    }
  });

  $("ys").textContent=GBP(ySpend);
  $("as").textContent=GBP(aSpend);
  $("yp").textContent=GBP(Math.max(0,yPaidGross-aPaid));
  $("yr").textContent=GBP(ySpend-(yPaidGross-aPaid));
  $("ap").textContent=GBP(aPaid);
  $("ar").textContent=GBP(aSpend-aPaid);

  let months=Object.keys(monthly).sort(),i=months.length-1;
  $("monthLabel").textContent=monthPretty(months[i]);

  const pieChart=new Chart(pie,{
    type:"doughnut",
    data:{datasets:[{data:[ySpend,aSpend],backgroundColor:["#2f7dff","#ff4fb0"],cutout:"68%",offset:[0,0]}]}